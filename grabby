#!/bin/bash

# grabby - The Ultimate AI-Assisted Dev Infrastructure Injector
# Created by alexandeism

set -e

# Visual Markers
DONE="âœ…"
WAIT="â³"
WARN="âš ï¸ "
FIRE="ðŸš€"
SHIT="ðŸ’©"

echo -e "$FIRE \033[1mGRABBY: Project Infection Starting...\033[0m"

# 1. Dependency Check (The Muscles)
check_brew() {
    if ! command -v brew &> /dev/null; then
        echo -e "$WARN Homebrew not found. This script works best with brew, retard."
        echo -e "$WAIT Attempting to install Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || { echo -e "$SHIT Brew install failed. Do it yourself."; exit 1; }
    fi
}

check_global_tool() {
    if ! command -v "$1" &> /dev/null; then
        echo -e "$WAIT $1 not found. Triggering automated installation..."
        if [[ "$1" == "mgrep" ]]; then
            # The correct package for semantic mgrep
            npm install -g @mixedbread-ai/mgrep || { echo -e "$SHIT Failed to install mgrep."; exit 1; }
        elif [[ "$1" == "comby" ]]; then
            brew install comby || { echo -e "$SHIT Failed to install comby."; exit 1; }
        fi
        echo -e "$DONE $1 installed successfully."
    else
        echo -e "$DONE $1 is ready."
    fi
}

check_brew
check_global_tool "mgrep"
check_global_tool "comby"

# 2. Local Architecture Injection (The Brain)
if [[ ! -d "Skills" ]]; then
    echo -e "$WAIT Injecting Skills/ Knowledge Base..."
    # Placeholder: In production, this would clone from your official repo
    # git clone --depth 1 https://github.com/alexandeism/grabby-skills.git temp_skills
    # mv temp_skills/Skills ./Skills
    # rm -rf temp_skills
    
    # For now, we assume the user is running this from a context where they have access to the repo
    # or we simulate the structure
    mkdir -p Skills/skills Skills/workflows
    echo -e "$DONE Skills/ directory scaffolded."
else
    echo -e "$DONE Skills/ already exists. Updating knowledge..."
    # cd Skills && git pull && cd ..
fi

# 3. Grabby Core Integration (The Eyes)
# Detect project type
if [[ -f "vite.config.ts" || -f "vite.config.js" ]]; then
    echo -e "$WAIT Vite project detected. Running setup-vite..."
    npx @grabby/inspector setup:vite
elif [[ -f "next.config.js" || -f "next.config.mjs" ]]; then
    echo -e "$WAIT Next.js project detected. Running setup-next..."
    npx @grabby/inspector setup:next
else
    echo -e "$WARN No supported framework detected. Manual adapter setup required."
fi

# 4. Initialize AI Workflow (The Synapse)
if [[ -f "Skills/workflows/mgrep-init.sh" ]]; then
    echo -e "$WAIT Initializing AI Semantic Search..."
    bash Skills/workflows/mgrep-init.sh
fi

echo -e "\n$FIRE \033[1mINFECTION COMPLETE.\033[0m"
echo -e "1. Start your dev server."
echo -e "2. Add \033[34m?grab=true\033[0m to your local URL."
echo -e "3. Click elements to feed the AI."
echo -e "\n\033[32mGo build some god-tier.\033[0m\n"
